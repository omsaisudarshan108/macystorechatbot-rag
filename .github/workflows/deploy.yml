name: Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy backend
        run: gcloud run deploy ${{ secrets.BACKEND_SERVICE }} --source . --region ${{ secrets.GCP_REGION }} --allow-unauthenticated --command uvicorn --args backend.api.main:app,--host,0.0.0.0,--port,$PORT --set-env-vars PROJECT_ID=${{ secrets.GCP_PROJECT_ID }} --memory 2Gi --quiet

      - name: Deploy frontend
        run: gcloud run deploy ${{ secrets.UI_SERVICE }} --source . --region ${{ secrets.GCP_REGION }} --allow-unauthenticated --command streamlit --args run,ui/app.py,--server.port=$PORT,--server.address=0.0.0.0,--server.headless=true --set-env-vars API_URL=${{ secrets.API_URL }} --memory 1Gi --quiet
